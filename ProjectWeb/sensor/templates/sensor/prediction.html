<!DOCTYPE html>
<html>
<head>
    <title>Sensor Prediction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <style>
        :root {
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --accent-color: #ff5e62;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
        }
        
        body {
            background: linear-gradient(135deg, var(--light-bg) 0%, #e9ecef 100%);
            min-height: 100vh;
        }
        
        .navbar-custom {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 6px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            background: white;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border: none;
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #8e2de2, #4a00e0);
            border: none;
        }
        
        .btn-danger {
            background: linear-gradient(to right, var(--accent-color), #ff9966);
            border: none;
        }
        
        .prediction-card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
        }
        
        .sensor-input-group {
            margin-bottom: 1.5rem;
        }
        
        .sensor-input-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .prediction-result {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin-top: 1rem;
        }
        
        .chart-container {
            height: 400px;
            margin-top: 2rem;
        }
        
        .info-icon {
            color: var(--secondary-color);
            margin-right: 0.5rem;
        }
        
        .prediction-badge {
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 10px;
        }
        
        .temp-badge {
            background-color: rgba(255, 99, 132, 0.2);
            border: 1px solid rgba(255, 99, 132, 0.5);
            color: #ff6384;
        }
        
        .hum-badge {
            background-color: rgba(54, 162, 235, 0.2);
            border: 1px solid rgba(54, 162, 235, 0.5);
            color: #36a2eb;
        }
        
        .light-badge {
            background-color: rgba(255, 206, 86, 0.2);
            border: 1px solid rgba(255, 206, 86, 0.5);
            color: #ffce56;
        }
        
        .snd-badge {
            background-color: rgba(75, 192, 192, 0.2);
            border: 1px solid rgba(75, 192, 192, 0.5);
            color: #4bc0c0;
        }
        
        .duration-buttons .btn {
            margin: 0.2rem;
            flex-grow: 1;
        }
        
        .duration-buttons {
            display: flex;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">IoT Sensor Dashboard</a>
            <div class="d-flex">
                <a href="/" class="btn btn-light btn-sm me-2">
                    <i class="fas fa-home me-1"></i> Home
                </a>
                <a href="/dashboard/" class="btn btn-light btn-sm me-2">Dashboard</a>
                <a href="/charts/" class="btn btn-light btn-sm me-2">Detail boards</a>
                <a href="/data/" class="btn btn-light btn-sm me-2">Raw Data</a>
                <a href="/events/integrated" class="btn btn-light btn-sm me-2">Event Dashboard</a>
                <a href="/predict/" class="btn btn-light btn-sm me-2 active">AI Prediction</a>
                <a href="/alarm/" class="btn btn-light btn-sm me-2"><i class="fas fa-bell me-1"></i>Alarms</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-lg-10 offset-lg-1">
                <div class="card prediction-card">
                    <div class="card-header bg-gradient-primary text-white">
                        <i class="fas fa-brain me-2"></i> AI Sensor Prediction
                    </div>
                    <div class="card-body">
                        <form id="predictionForm">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="sensor-input-group">
                                        <label for="node_id" class="sensor-input-label">
                                            <i class="fas fa-microchip info-icon"></i>Node ID
                                        </label>
                                        <select class="form-select" id="node_id" name="node_id" required>
                                            <option value="">Select Node</option>
                                            {% for node_id in node_ids %}
                                                <option value="{{ node_id }}">{{ node_id }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="sensor-input-group">
                                        <label for="loc" class="sensor-input-label">
                                            <i class="fas fa-map-marker-alt info-icon"></i>Location
                                        </label>
                                        <select class="form-select" id="loc" name="loc" required>
                                            <option value="">Select Location</option>
                                            {% for loc in locations %}
                                                <option value="{{ loc }}">{{ loc }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="sensor-input-group">
                                        <label for="target" class="sensor-input-label">
                                            <i class="fas fa-bullseye info-icon"></i>Predict
                                        </label>
                                        <select class="form-select" id="target" name="target" required>
                                            <option value="">Select Value to Predict</option>
                                            {% for type in prediction_types %}
                                                <option value="{{ type.value }}">{{ type.label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div id="inputFields">
                                        <!-- Dynamic input fields will be inserted here based on target selection -->
                                        <div class="alert alert-info">
                                            Select a value to predict to see required input fields
                                        </div>
                                    </div>
                                    
                                    <div class="sensor-input-group">
                                        <label class="sensor-input-label">
                                            <i class="fas fa-clock info-icon"></i>Prediction Duration
                                        </label>
                                        <div class="duration-buttons">
                                            <button type="button" class="btn btn-outline-primary duration-btn" data-hours="1">1 Hour</button>
                                            <button type="button" class="btn btn-outline-primary duration-btn" data-hours="3">3 Hours</button>
                                            <button type="button" class="btn btn-outline-primary duration-btn" data-hours="6">6 Hours</button>
                                            <button type="button" class="btn btn-outline-primary duration-btn" data-hours="12">12 Hours</button>
                                            <button type="button" class="btn btn-outline-primary duration-btn" data-hours="24">24 Hours</button>
                                        </div>
                                        <input type="hidden" id="duration" name="duration" value="1">
                                    </div>
                                    
                                    <div class="sensor-input-group text-center">
                                        <button type="submit" class="btn btn-primary btn-lg mt-3 w-100">
                                            <i class="fas fa-chart-line me-2"></i> Predict Future Values
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        
                        <div id="resultContainer" class="mt-4" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-gradient-info text-white">
                                    <i class="fas fa-chart-area me-2"></i> Future Prediction Results
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="predictionChart"></canvas>
                                    </div>
                                    
                                    <div class="table-responsive mt-4">
                                        <h5><i class="fas fa-table me-2"></i>Prediction Data</h5>
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Timestamp</th>
                                                    <th>Predicted Value</th>
                                                </tr>
                                            </thead>
                                            <tbody id="predictionTableBody">
                                                <!-- Table rows will be inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header bg-gradient-info text-white">
                        <i class="fas fa-info-circle me-2"></i> How It Works
                    </div>
                    <div class="card-body">
                        <p>This prediction system uses neural network models trained on historical sensor data to estimate future sensor values:</p>
                        
                        <ul>
                            <li>Select the sensor node and location you want to analyze</li>
                            <li>Choose which value you want to predict (temperature, humidity, light, or sound)</li>
                            <li>Provide current values for the other sensor readings</li>
                            <li>Select how far into the future you want to predict (1-24 hours)</li>
                            <li>The system will generate predictions at 15-minute intervals</li>
                        </ul>
                        
                        <div class="mt-3">
                            <h5><i class="fas fa-lightbulb me-2"></i>Prediction Models</h5>
                            <div class="d-flex flex-wrap gap-2">
                                <span class="prediction-badge temp-badge">
                                    <i class="fas fa-temperature-high me-1"></i> Temperature Model
                                </span>
                                <span class="prediction-badge hum-badge">
                                    <i class="fas fa-tint me-1"></i> Humidity Model
                                </span>
                                <span class="prediction-badge light-badge">
                                    <i class="fas fa-sun me-1"></i> Light Model
                                </span>
                                <span class="prediction-badge snd-badge">
                                    <i class="fas fa-volume-up me-1"></i> Sound Model
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Font Awesome for icons -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize chart
            const predictionChart = new Chart(
                document.getElementById('predictionChart'),
                {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Predicted Values',
                            borderColor: '#6a11cb',
                            backgroundColor: 'rgba(106, 17, 203, 0.1)',
                            borderWidth: 3,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#6a11cb',
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: true,
                            tension: 0.3,
                            data: []
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'hour',
                                    tooltipFormat: 'MMM D, h:mm A'
                                },
                                grid: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Value'
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            }
                        }
                    }
                }
            );
            
            // Target selection change handler
            document.getElementById('target').addEventListener('change', function() {
                updateInputFields(this.value);
                updateChartTitle(this.value);
            });
            
            // Duration button click handler
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Set active state
                    document.querySelectorAll('.duration-btn').forEach(b => {
                        b.classList.remove('active', 'btn-primary');
                        b.classList.add('btn-outline-primary');
                    });
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('active', 'btn-primary');
                    
                    // Update hidden input
                    document.getElementById('duration').value = this.dataset.hours;
                });
            });
            
            // Set default duration (1 hour)
            document.querySelector('.duration-btn[data-hours="1"]').click();
            
            // Update chart title based on selected target
            function updateChartTitle(target) {
                let title = 'Predicted Values';
                if (target === 'temp') title = 'Predicted Temperature (°C)';
                else if (target === 'hum') title = 'Predicted Humidity (%)';
                else if (target === 'light') title = 'Predicted Light Level';
                else if (target === 'snd') title = 'Predicted Sound Level (dB)';
                
                predictionChart.data.datasets[0].label = title;
                predictionChart.options.scales.y.title.text = title.split(':')[0];
                predictionChart.update();
            }
            
            // Update input fields based on target selection
            function updateInputFields(target) {
                const inputFields = document.getElementById('inputFields');
                
                if (!target) {
                    inputFields.innerHTML = `
                        <div class="alert alert-info">
                            Select a value to predict to see required input fields
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                // Define fields needed for each target
                const fieldConfig = {
                    'temp': [
                        {id: 'hum', label: 'Humidity (%)', icon: 'tint', min: 0, max: 100, step: 0.1},
                        {id: 'light', label: 'Light Level', icon: 'sun', min: 0, step: 1},
                        {id: 'snd', label: 'Sound Level (dB)', icon: 'volume-up', min: -100, max: 0, step: 0.1}
                    ],
                    'hum': [
                        {id: 'temp', label: 'Temperature (°C)', icon: 'temperature-high', min: -20, max: 50, step: 0.1},
                        {id: 'light', label: 'Light Level', icon: 'sun', min: 0, step: 1},
                        {id: 'snd', label: 'Sound Level (dB)', icon: 'volume-up', min: -100, max: 0, step: 0.1}
                    ],
                    'light': [
                        {id: 'temp', label: 'Temperature (°C)', icon: 'temperature-high', min: -20, max: 50, step: 0.1},
                        {id: 'hum', label: 'Humidity (%)', icon: 'tint', min: 0, max: 100, step: 0.1},
                        {id: 'snd', label: 'Sound Level (dB)', icon: 'volume-up', min: -100, max: 0, step: 0.1}
                    ],
                    'snd': [
                        {id: 'temp', label: 'Temperature (°C)', icon: 'temperature-high', min: -20, max: 50, step: 0.1},
                        {id: 'hum', label: 'Humidity (%)', icon: 'tint', min: 0, max: 100, step: 0.1},
                        {id: 'light', label: 'Light Level', icon: 'sun', min: 0, step: 1}
                    ]
                };
                
                // Generate input fields
                fieldConfig[target].forEach(field => {
                    html += `
                        <div class="sensor-input-group">
                            <label for="${field.id}" class="sensor-input-label">
                                <i class="fas fa-${field.icon} info-icon"></i>${field.label}
                            </label>
                            <input type="number" class="form-control" id="${field.id}" name="${field.id}"
                                   min="${field.min || ''}" max="${field.max || ''}" step="${field.step || 'any'}" required>
                        </div>
                    `;
                });
                
                inputFields.innerHTML = html;
                
                // Populate with sample data for testing
                populateSampleData(target);
            }
            
            // Populate form with sample data for testing
            function populateSampleData(target) {
                const samples = {
                    'A01': {
                        loc: 'W311A',
                        temp: 22.5,
                        hum: 45,
                        light: 50,
                        snd: -63
                    },
                    'A07': {
                        loc: 'W311D-Z2',
                        temp: 23.1,
                        hum: 47,
                        light: 35,
                        snd: -58
                    }
                };
                
                const nodeId = document.getElementById('node_id').value;
                if (nodeId && samples[nodeId]) {
                    document.getElementById('loc').value = samples[nodeId].loc;
                    
                    if (target !== 'temp' && document.getElementById('temp')) {
                        document.getElementById('temp').value = samples[nodeId].temp;
                    }
                    if (target !== 'hum' && document.getElementById('hum')) {
                        document.getElementById('hum').value = samples[nodeId].hum;
                    }
                    if (target !== 'light' && document.getElementById('light')) {
                        document.getElementById('light').value = samples[nodeId].light;
                    }
                    if (target !== 'snd' && document.getElementById('snd')) {
                        document.getElementById('snd').value = samples[nodeId].snd;
                    }
                }
            }
            
            // Form submission handler
            document.getElementById('predictionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Predicting...';
                
                // Get form data
                const formData = {
                    node_id: document.getElementById('node_id').value,
                    loc: document.getElementById('loc').value,
                    target: document.getElementById('target').value,
                    duration: document.getElementById('duration').value
                };
                
                // Add input values
                if (formData.target !== 'temp') formData.temp = document.getElementById('temp').value;
                if (formData.target !== 'hum') formData.hum = document.getElementById('hum').value;
                if (formData.target !== 'light') formData.light = document.getElementById('light').value;
                if (formData.target !== 'snd') formData.snd = document.getElementById('snd').value;
                
                // Make AJAX request
                fetch('/predict-future-values/', {
                    method: 'POST',
                    body: JSON.stringify(formData),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken'),
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show results
                        const resultsContainer = document.getElementById('resultContainer');
                        resultsContainer.style.display = 'block';
                        
                        // Update chart
                        predictionChart.data.datasets[0].data = data.predictions.map(p => ({
                            x: p.timestamp,
                            y: p.value
                        }));
                        predictionChart.update();
                        
                        // Update table
                        const tableBody = document.getElementById('predictionTableBody');
                        tableBody.innerHTML = data.predictions.map(p => `
                            <tr>
                                <td>${new Date(p.timestamp).toLocaleString()}</td>
                                <td>${p.value.toFixed(2)}</td>
                            </tr>
                        `).join('');
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while making the prediction.');
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-chart-line me-2"></i> Predict Future Values';
                });
            });
            
            // Helper function to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            // Initialize Select2 for better select controls
            if (typeof $ !== 'undefined' && $.fn.select2) {
                $('#node_id, #loc, #target').select2({
                    width: '100%',
                    theme: 'bootstrap-5'
                });
            }
        });
    </script>
</body>
</html>